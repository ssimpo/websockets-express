function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}!function(e,t){"use strict";var n,r=e.buffer,o=!1,a=new Set,i="main",u="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz".split(""),c=new Map,s=new Map,f=new Map,l=new Map,d=new Map,v=new Map,h=new Map,g=Object.freeze({CONNECTING:1,RECONNECTING:2,CLOSED:3,CONNECTED:4});function E(){e.document.addEventListener("DOMContentLoaded",p),t&&(t.websocket=new S),e.angular&&e.angular.module("websocket-express",[]).factory("$websocket",function(){return new S}),t||e.angular||(e.bolt?e.bolt.WebSocketService=S:e.BoltWebSocketService=S)}function p(){!function(){!function(){var t,n=e.location.origin,r=e.document.querySelector("base[href]");if(r){var o=(r.getAttribute("href")||"").trim().replace(n,"");""!==o&&(t=n+o)}else t=n+"/";t=t.replace("https://","wss://").replace("http://","ws://"),c.set(i,t)}();var t=e.document.querySelectorAll("link[rel=websocket-endpoint][href]");if(t.length)for(var n=0;n<t.length;n++){var r=(t[n].getAttribute("href")||"").trim();if(""!==r){var o=(t[n].getAttribute("title")||"").trim();""===o&&(o=i),c.set(o,r)}}}(),o=!0,a.forEach(function(e){return e()}),a.clear(),e.document.removeEventListener("DOMContentLoaded",E)}function w(e,t,n){var r=!0;return n.forEach(function(n){r=r&&e!==t[n]}),r}function y(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:32;return new Array(e).fill(0).map(function(){return u[function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Math.floor(Math.random()*e)+t}(u.length-1)]}).join("")}function C(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i;if(d.has(e)){var t=d.get(e);return t.readyState===t.OPEN?t:void 0}}function N(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i;return s.has(t)||s.set(t,new Map),s.get(t).has(e)||s.get(t).set(e,new Set),s.get(t).get(e)}function k(e,t){e.forEach(function(e){return e.delete(t)})}function m(e,t,n){function o(){h.set(n,g.CONNECTED),console.log("Opened ".concat(t," for ").concat(n)),e.addEventListener("close",a),e.addEventListener("message",u),function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i,t=l.get(e),n=C(e);t&&n&&(t.forEach(function(e){return n.send(e())}),t.clear(),l.delete(e))}(n)}function a(){var r,a;h.set(n,g.CLOSED),console.log("Closed ".concat(t," for ").concat(n)),e.removeEventListener("open",o),e.removeEventListener("close",u),e.removeEventListener("message",u),r=t,a=n,d.delete(a),setTimeout(function(){w(h.get(a),g,["CONNECTING","RECONNECTING","CONNECTED"])&&(h.set(a,g.RECONNECTING),console.log("Trying reconnect"),d.set(a,new WebSocket(r)),m(d.get(a),r,a))},3e3)}function u(e){var t=function(e){if(e.id){if(f.has(e.id)){var t=f.get(e.id);"error"===e.type?t(e.data,null):t(null,e.data),f.delete(e.id)}}else s.has(e.type)&&s.get(type).forEach(function(t){return callback(e.data)})};if("string"==typeof e.data)t(JSON.parse(e.data));else if(e.data instanceof Blob){var n=new FileReader;n.onload=function(){t(new r.Buffer(new Uint8Array(this.result)))},n.readAsArrayBuffer(e.data)}}e.addEventListener("error",function(e){return console.error("Error on ".concat(t," for ").concat(n),e),a()}),e.addEventListener("open",o)}function b(e,t){e=function(e,t){if(e&&(o?c.set(t,e):a.add(function(){return c.set(t,e)})),!e&&!c.has(t))throw new URIError("No websocket endpoint for ".concat(t));return!e&&c.has(t)&&(e=c.get(t)),e}(e,t),w(h.get(t),g,["CONNECTING","RECONNECTING","CONNECTED"])&&(h.set(t,g.CONNECTING),d.has(t)||d.set(t,new WebSocket(e)),m(d.get(t),e,t))}function O(e){try{return JSON.stringify(e)}catch(e){throw new TypeError("Could not convert data to json for sending")}}var S=function(){function e(){return _classCallCheck(this,e),n||(n=this),this.addParser("json",O),n}return _createClass(e,[{key:"connect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i;if(!e&&!o)return a.add(function(){return b(e,t)});b(e,t)}},{key:"drop",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i;e=t,d.get(e).close()}},{key:"listen",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i;return N(t,n).add(e),function(){return N(t,n).delete(e)}}},{key:"removeListener",value:function(e,t){if(t&&s.has(t))return k(s.get(t),e);s.forEach(function(t){return k(t,e)})}},{key:"request",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"json";return e.method=e.method||"get",new Promise(function(r,o){var a,u,c=y();f.set(c,(a=r,u=o,function(e,t){if(e)return u(e);if((t.status||200)>=400){if(e)return u(e);var n=(t.statusMessage||"").trim();return u(n)}return a(t)}));var s={type:"request",id:c,data:e};!function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i,n=C(t);if(n)return n.send(e());l.has(t)||l.set(t,new Set),l.get(t).add(e)}(function(){if(v.has(n))return v.get(n)(s);throw new TypeError("No parser for type ".concat(n))},t)})}},{key:"requestJson",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i;return this.request(e,t,"json")}},{key:"ready",value:function(){return!!C(arguments.length>0&&void 0!==arguments[0]?arguments[0]:i)}},{key:"addEndpoint",value:function(e,t){return c.set(e,t),this}},{key:"removeEndpoint",value:function(e){return c.delete(e),this}},{key:"addParser",value:function(e,t){return v.set(e,t),this}},{key:"removeParser",value:function(e){return v.delete(e),this}},{key:"defaultSocketId",get:function(){return i}},{key:Symbol.toStringTag,get:function(){return"WebSocketService"}}]),e}();E()}(window,window.jQuery);
//# sourceMappingURL=websocket-express.min.js.map
