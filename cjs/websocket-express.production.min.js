"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var http=_interopDefault(require("http")),ws=_interopDefault(require("ws")),typeis=_interopDefault(require("type-is")),EventEmitter=_interopDefault(require("events")),mime=_interopDefault(require("mime")),_vary=_interopDefault(require("vary")),depd=_interopDefault(require("depd")),contentDisposition=_interopDefault(require("content-disposition")),statuses=_interopDefault(require("statuses")),crypto=_interopDefault(require("crypto"));function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _iterableToArrayLimit(e,t){var r=[],n=!0,a=!1,s=void 0;try{for(var o,i=e[Symbol.iterator]();!(n=(o=i.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){a=!0,s=e}finally{try{n||null==i.return||i.return()}finally{if(a)throw s}}return r}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function handleUpgrade(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new ws.Server({noServer:!0});return function(r,n,a){var s=new http.ServerResponse(r);s.assignSocket(n);var o=new Buffer(a.length);return a.copy(o),s.on("finish",function(){return s.socket.destroy()}),s.websocket=function(a){return t.handleUpgrade(r,n,o,function(r){t.emit("connection",r),a&&a(r,e)})},e(r,s)}}function arrayPush(e,t){for(var r=-1,n=t.length,a=e.length;++r<n;)e[a+r]=t[r];return e}var freeGlobal="object"==typeof global&&global&&global.Object===Object&&global,freeSelf="object"==typeof self&&self&&self.Object===Object&&self,root=freeGlobal||freeSelf||Function("return this")(),Symbol$1=root.Symbol,objectProto=Object.prototype,hasOwnProperty=objectProto.hasOwnProperty,nativeObjectToString=objectProto.toString,symToStringTag=Symbol$1?Symbol$1.toStringTag:void 0;function getRawTag(e){var t=hasOwnProperty.call(e,symToStringTag),r=e[symToStringTag];try{e[symToStringTag]=void 0}catch(e){}var n=nativeObjectToString.call(e);return t?e[symToStringTag]=r:delete e[symToStringTag],n}var objectProto$1=Object.prototype,nativeObjectToString$1=objectProto$1.toString;function objectToString(e){return nativeObjectToString$1.call(e)}var nullTag="[object Null]",undefinedTag="[object Undefined]",symToStringTag$1=Symbol$1?Symbol$1.toStringTag:void 0;function baseGetTag(e){return null==e?void 0===e?undefinedTag:nullTag:symToStringTag$1&&symToStringTag$1 in Object(e)?getRawTag(e):objectToString(e)}function isObjectLike(e){return null!=e&&"object"==typeof e}var argsTag="[object Arguments]";function baseIsArguments(e){return isObjectLike(e)&&baseGetTag(e)==argsTag}var objectProto$2=Object.prototype,hasOwnProperty$1=objectProto$2.hasOwnProperty,propertyIsEnumerable=objectProto$2.propertyIsEnumerable,isArguments=baseIsArguments(function(){return arguments}())?baseIsArguments:function(e){return isObjectLike(e)&&hasOwnProperty$1.call(e,"callee")&&!propertyIsEnumerable.call(e,"callee")},isArray=Array.isArray,spreadableSymbol=Symbol$1?Symbol$1.isConcatSpreadable:void 0;function isFlattenable(e){return isArray(e)||isArguments(e)||!!(spreadableSymbol&&e&&e[spreadableSymbol])}function baseFlatten(e,t,r,n,a){var s=-1,o=e.length;for(r||(r=isFlattenable),a||(a=[]);++s<o;){var i=e[s];t>0&&r(i)?t>1?baseFlatten(i,t-1,r,n,a):arrayPush(a,i):n||(a[a.length]=i)}return a}function flatten(e){return(null==e?0:e.length)?baseFlatten(e,1):[]}function isObject(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var asyncTag="[object AsyncFunction]",funcTag="[object Function]",genTag="[object GeneratorFunction]",proxyTag="[object Proxy]";function isFunction(e){if(!isObject(e))return!1;var t=baseGetTag(e);return t==funcTag||t==genTag||t==asyncTag||t==proxyTag}var coreJsData=root["__core-js_shared__"],maskSrcKey=function(){var e=/[^.]+$/.exec(coreJsData&&coreJsData.keys&&coreJsData.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}();function isMasked(e){return!!maskSrcKey&&maskSrcKey in e}var funcProto=Function.prototype,funcToString=funcProto.toString;function toSource(e){if(null!=e){try{return funcToString.call(e)}catch(e){}try{return e+""}catch(e){}}return""}var reRegExpChar=/[\\^$.*+?()[\]{}|]/g,reIsHostCtor=/^\[object .+?Constructor\]$/,funcProto$1=Function.prototype,objectProto$3=Object.prototype,funcToString$1=funcProto$1.toString,hasOwnProperty$2=objectProto$3.hasOwnProperty,reIsNative=RegExp("^"+funcToString$1.call(hasOwnProperty$2).replace(reRegExpChar,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function baseIsNative(e){return!(!isObject(e)||isMasked(e))&&(isFunction(e)?reIsNative:reIsHostCtor).test(toSource(e))}function getValue(e,t){return null==e?void 0:e[t]}function getNative(e,t){var r=getValue(e,t);return baseIsNative(r)?r:void 0}var nativeCreate=getNative(Object,"create");function hashClear(){this.__data__=nativeCreate?nativeCreate(null):{},this.size=0}function hashDelete(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}var HASH_UNDEFINED="__lodash_hash_undefined__",objectProto$4=Object.prototype,hasOwnProperty$3=objectProto$4.hasOwnProperty;function hashGet(e){var t=this.__data__;if(nativeCreate){var r=t[e];return r===HASH_UNDEFINED?void 0:r}return hasOwnProperty$3.call(t,e)?t[e]:void 0}var objectProto$5=Object.prototype,hasOwnProperty$4=objectProto$5.hasOwnProperty;function hashHas(e){var t=this.__data__;return nativeCreate?void 0!==t[e]:hasOwnProperty$4.call(t,e)}var HASH_UNDEFINED$1="__lodash_hash_undefined__";function hashSet(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=nativeCreate&&void 0===t?HASH_UNDEFINED$1:t,this}function Hash(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function listCacheClear(){this.__data__=[],this.size=0}function eq(e,t){return e===t||e!=e&&t!=t}function assocIndexOf(e,t){for(var r=e.length;r--;)if(eq(e[r][0],t))return r;return-1}Hash.prototype.clear=hashClear,Hash.prototype.delete=hashDelete,Hash.prototype.get=hashGet,Hash.prototype.has=hashHas,Hash.prototype.set=hashSet;var arrayProto=Array.prototype,splice=arrayProto.splice;function listCacheDelete(e){var t=this.__data__,r=assocIndexOf(t,e);return!(r<0)&&(r==t.length-1?t.pop():splice.call(t,r,1),--this.size,!0)}function listCacheGet(e){var t=this.__data__,r=assocIndexOf(t,e);return r<0?void 0:t[r][1]}function listCacheHas(e){return assocIndexOf(this.__data__,e)>-1}function listCacheSet(e,t){var r=this.__data__,n=assocIndexOf(r,e);return n<0?(++this.size,r.push([e,t])):r[n][1]=t,this}function ListCache(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}ListCache.prototype.clear=listCacheClear,ListCache.prototype.delete=listCacheDelete,ListCache.prototype.get=listCacheGet,ListCache.prototype.has=listCacheHas,ListCache.prototype.set=listCacheSet;var Map$1=getNative(root,"Map");function mapCacheClear(){this.size=0,this.__data__={hash:new Hash,map:new(Map$1||ListCache),string:new Hash}}function isKeyable(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}function getMapData(e,t){var r=e.__data__;return isKeyable(t)?r["string"==typeof t?"string":"hash"]:r.map}function mapCacheDelete(e){var t=getMapData(this,e).delete(e);return this.size-=t?1:0,t}function mapCacheGet(e){return getMapData(this,e).get(e)}function mapCacheHas(e){return getMapData(this,e).has(e)}function mapCacheSet(e,t){var r=getMapData(this,e),n=r.size;return r.set(e,t),this.size+=r.size==n?0:1,this}function MapCache(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}MapCache.prototype.clear=mapCacheClear,MapCache.prototype.delete=mapCacheDelete,MapCache.prototype.get=mapCacheGet,MapCache.prototype.has=mapCacheHas,MapCache.prototype.set=mapCacheSet;var HASH_UNDEFINED$2="__lodash_hash_undefined__";function setCacheAdd(e){return this.__data__.set(e,HASH_UNDEFINED$2),this}function setCacheHas(e){return this.__data__.has(e)}function SetCache(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new MapCache;++t<r;)this.add(e[t])}function baseFindIndex(e,t,r,n){for(var a=e.length,s=r+(n?1:-1);n?s--:++s<a;)if(t(e[s],s,e))return s;return-1}function baseIsNaN(e){return e!=e}function strictIndexOf(e,t,r){for(var n=r-1,a=e.length;++n<a;)if(e[n]===t)return n;return-1}function baseIndexOf(e,t,r){return t==t?strictIndexOf(e,t,r):baseFindIndex(e,baseIsNaN,r)}function arrayIncludes(e,t){return!!(null==e?0:e.length)&&baseIndexOf(e,t,0)>-1}function arrayIncludesWith(e,t,r){for(var n=-1,a=null==e?0:e.length;++n<a;)if(r(t,e[n]))return!0;return!1}function cacheHas(e,t){return e.has(t)}SetCache.prototype.add=SetCache.prototype.push=setCacheAdd,SetCache.prototype.has=setCacheHas;var Set$1=getNative(root,"Set");function noop(){}function setToArray(e){var t=-1,r=Array(e.size);return e.forEach(function(e){r[++t]=e}),r}var INFINITY=1/0,createSet=Set$1&&1/setToArray(new Set$1([,-0]))[1]==INFINITY?function(e){return new Set$1(e)}:noop,LARGE_ARRAY_SIZE=200;function baseUniq(e,t,r){var n=-1,a=arrayIncludes,s=e.length,o=!0,i=[],c=i;if(r)o=!1,a=arrayIncludesWith;else if(s>=LARGE_ARRAY_SIZE){var u=t?null:createSet(e);if(u)return setToArray(u);o=!1,a=cacheHas,c=new SetCache}else c=t?[]:i;e:for(;++n<s;){var l=e[n],h=t?t(l):l;if(l=r||0!==l?l:0,o&&h==h){for(var f=c.length;f--;)if(c[f]===h)continue e;t&&c.push(h),i.push(l)}else a(c,h,r)||(c!==i&&c.push(h),i.push(l))}return i}function uniq(e){return e&&e.length?baseUniq(e):[]}var stringTag="[object String]";function isString(e){return"string"==typeof e||!isArray(e)&&isObjectLike(e)&&baseGetTag(e)==stringTag}var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz".split("");function randomInt(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Math.floor(Math.random()*e)+t}function randomString(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:32;return new Array(e).fill(0).map(function(){return chars[randomInt(chars.length-1)]}).join("")}function getContentLength(e){try{return isObject(e)?JSON.stringify(e||{}).length.toString():e.toString().length.toString()}catch(e){}return"1"}function definePropertyFixed(e,t,r){return makeArray(t).forEach(function(n,a){return Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:function(){return Array.isArray(t)?r[a]:r},set:function(){return!1}})}),e}function defineProperty(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return makeArray(t).forEach(function(a,s){return Object.defineProperty(e,a,{configurable:n,enumerable:!0,writable:!0,value:Array.isArray(t)?r[s]:r})}),e}function rebinder(e,t,r){return makeArray(r.methods).forEach(function(r){t[r]=e[r].bind(t)}),makeArray(r.properties).forEach(function(r){return Object.defineProperty(t,r,{get:function(){return e[r]},set:function(t){e[r]=t}})}),e}function makeArray(e){return void 0===e?[]:e instanceof Set?_toConsumableArray(e):Array.isArray(e)?e:[e]}var ignoreHeaders=["upgrade","sec-websocket-key","sec-websocket-version","sec-websocket-extensions"],addHeaders={Connection:"keep-alive"};function excludeHeader(e){return Object.keys(addHeaders).includes(e.toString())||ignoreHeaders.includes(e.toString().toLowerCase())}function rawHeadersFactory(e,t){var r=!1;return flatten.apply(void 0,_toConsumableArray(Object.keys(addHeaders).map(function(e){return[e,addHeaders[e]]}))).concat(e.rawHeaders.map(function(e){if(!r&&!excludeHeader(e))return e;r=!r}).filter(function(e){return e})).concat(flatten.apply(void 0,_toConsumableArray(Object.keys(t.headers).map(function(e){return[e,t.headers[e]]}))).map(function(e){if(!r&&!excludeHeader(e))return e;r=!r}).filter(function(e){return e}))}function requestHeadersFactory(e,t){var r={};return Object.keys(e.headers).forEach(function(t){var n=t.toLocaleLowerCase();ignoreHeaders.includes(n)||(r[n]=e.headers[t])}),Object.keys(t.headers||{}).forEach(function(e){r[e.toLocaleLowerCase()]=t.headers[e]}),Object.keys(addHeaders).forEach(function(e){r[e.toLocaleLowerCase()]=addHeaders[e]}),new Proxy(r,{get:function(t,r,n){return Reflect.get(t,r,n)||(ignoreHeaders.includes(r)?void 0:Reflect.get(e.headers,r,n))},set:function(e,t,r,n){return Reflect.set(e,t,r,n)},has:function(t,r){return Reflect.has(t,r)||(ignoreHeaders.includes(r)?void 0:Reflect.has(e.headers,r))},getOwnPropertyDescriptor:function(t,r){return Reflect.has(t,r)?Reflect.getOwnPropertyDescriptor(t,r):!ignoreHeaders.includes(r)&&Reflect.has(e.headers,r)?Reflect.getOwnPropertyDescriptor(e.headers,r):void 0},ownKeys:function(t){var r=Reflect.ownKeys(e.headers).filter(function(e){return!ignoreHeaders.includes(e)});return uniq(Reflect.ownKeys(t).concat(r))}})}var originalRequests=new WeakMap,originalMessages=new WeakMap,rebind={methods:["accepts","acceptsCharsets","acceptsEncodings","acceptsLanguages","param"],properties:["hostname","ip","ips","subdomains","cookies","signedCookies","sessionID","session"]};function getBody(e){return isObject(e.body)?Object.assign({},e.body):e.body||{}}var WebsocketRequestAbstract={get:function(e){return this.headers[e]},is:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return typeis(this,t)}},WebsocketRequest=function(e){function t(e,r,n,a){var s;return _classCallCheck(this,t),defineProperty(_assertThisInitialized(_assertThisInitialized(s=_possibleConstructorReturn(this,_getPrototypeOf(t).call(this)))),"body",getBody(r),!0),defineProperty(_assertThisInitialized(_assertThisInitialized(s)),["method","originalUrl","params","path","query","url"],[r.method,r.path,{},r.path,{},r.path]),definePropertyFixed(_assertThisInitialized(_assertThisInitialized(s)),["app","headers","messageId","protocol","rawHeaders","secure","websocket","xhr","_req","websocketId"],[e.app,requestHeadersFactory(e,r),n,e.secure?"wss":"ws",rawHeadersFactory(e,r),e.secure,!0,!1,e,a]),rebinder(WebsocketRequestAbstract,_assertThisInitialized(_assertThisInitialized(s)),{methods:Object.keys(WebsocketRequestAbstract)}),rebinder(e,_assertThisInitialized(_assertThisInitialized(s)),rebind),originalRequests.set(_assertThisInitialized(_assertThisInitialized(s)),e),originalMessages.set(_assertThisInitialized(_assertThisInitialized(s)),r),s}return _inherits(t,EventEmitter),t}(),deprecate=depd("express"),clients=new WeakMap,messageIdIds=new WeakMap,messageRecieveType=new WeakMap;function createResponseMessage(e,t){return{id:messageIdIds.get(e),type:"response",data:{path:e.req.originalUrl,body:t,headers:e.headers||{},status:e.statusCode,statusMessage:e.statusMessage||"",type:e.get("Content-Type")||"application/json"}}}function sendMessage(e,t){messageRecieveType.get(e);var r=clients.get(e);return r&&r.send(JSON.stringify(t)),e.headersSent=!0,e}var WebsocketResponseAbstract={append:function(e,t){var r=this.get(e),n=t;return r&&(n=Array.isArray(r)?r.concat(t):Array.isArray(t)?[r].concat(t):[r,t]),this.set(e,n)},attachment:function(e){return e&&this.type(extname(e)),this.set("Content-Disposition",contentDisposition(e)),this},cookie:function(e,t,r){},clearCookie:function(e,t){},download:function(e,t,r){},end:function(e,t){},format:function(e){},get:function(e){return this.headers[e]},getHeader:function(e){return this.get(e)},getHeaderNames:function(){return Object.keys(this.headers).sort()},getHeaders:function(){return this.headers},hasHeader:function(e){return e in this.headers},json:function(e){return this.type("application/json"),this.send(e)},jsonp:function(e){return this.type("application/javascript"),createResponseMessage(this,e).data.callback=this.app.get("jsonp callback name")||"callback",this.send(e)},links:function(e){},location:function(e){this.set("location",e)},redirect:function(e,t){t||(t=e=302),this.status(e),this.type("plain/text"),this.send(t)},render:function(e,t,r){},send:function(e){return sendMessage(this,createResponseMessage(this,e))},sendFile:function(e,t,r){},sendStatus:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:statuses[e]||this.statusMessage;this.status(e),this.type("plain/text"),this.send(t)},set:function(e,t){var r=this.headers;isObject(e)?Object.keys(e).forEach(function(t){r[t]=e[t]}):r[e]=t},setHeader:function(e,t){return this.set(e,t)},status:function(e){return this.statusCode=e,this.statusMessage=statuses[e],this},type:function(e){return this.set("Content-Type",-1===e.indexOf("/")?mime.lookup(e):e)},vary:function(e){return!e||Array.isArray(e)&&!e.length?(deprecate("res.vary(): Provide a field name"),this):(_vary(this,e),this)}},WebsocketResponse=function e(t,r,n,a){_classCallCheck(this,e),defineProperty(this,["headers","headersSent","statusCode","statusMessage"],[{},!1,200,"Ok"]),definePropertyFixed(this,["locals","req","app","websocketClient"],[{},t,t.app,r]),rebinder(WebsocketResponseAbstract,this,{methods:Object.keys(WebsocketResponseAbstract)}),clients.set(this,r),messageIdIds.set(this,n),messageRecieveType.set(this,a)};function isWebsocket(e){return!(e.websocket||!e.headers||void 0===e.headers.upgrade||"websocket"!==e.headers.upgrade.toLowerCase())}function parseMessage(e){if(isString(e))try{return["json",JSON.parse(e)]}catch(e){}return["unknown",void 0]}function generateMessageId(e,t){var r=crypto.createHash("sha1");return r.update("".concat(e.id).concat(t.sessionID)),r.digest("hex")}function handleRequest(e){var t=e.message,r=e.app,n=e.req,a=e.client,s=e.messageId,o=e.type;t.data.headers=Object.assign(t.data.headers||{},{"Content-Type":"application/json","Transfer-Encoding":"identity","Content-Length":getContentLength(t.data.body)});var i=new WebsocketRequest(n,t.data,s,a.id),c=new WebsocketResponse(i,a,t.id,o);r.handle(i,c)}function websocketMiddleware(e,t,r){if(!isWebsocket(e))return r();t.websocket(function(t,r){t.id=randomString(),r.getWebsocketClient=function(e){return makeArray((r.wss||{}).clients).find(function(t){return t.id===e})},t.on("message",function(n){var a=_slicedToArray(parseMessage(n),2),s=a[0],o=a[1];if(o&&o.type){var i=generateMessageId(o,e);if("request"===o.type)return handleRequest({message:o,app:r,req:e,client:t,messageId:i,type:s})}})})}function upgrade(e,t){var r=new ws.Server({noServer:!0});return e.on("upgrade",handleUpgrade(t,r)),r}exports.websocketMiddleware=websocketMiddleware,exports.upgrade=upgrade;
//# sourceMappingURL=websocket-express.production.min.js.map
